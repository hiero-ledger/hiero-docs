# Seguridad inteligente del contrato

El [Hedera Smart Contract Service (HSCS)](../../support-and-community/glossary. d#hedera-smart-contract-service-hscs) integra las características de la funcionalidad de entidad nativa de tercera generación de Hedera: alta finalidad rápida, comisiones predecibles y asequibles, y pedidos justos de transacciones—con una segunda generación altamente optimizada y rentable [Ethereum Virtual Machine (EVM)](. /../support-and-community/glossary.md#ethereum-virtual-machine-evm). Nuestro objetivo es ofrecer soporte integral para contratos inteligentes originalmente escritos para otras cadenas compatibles con EVM y permitir su implementación sin problemas en Hedera.

***

## Equivalencia EVM

Nos esforzamos por asegurar que los desarrolladores puedan apuntar convenientemente a un endpoint RPC soportado por Hedera y llevar a cabo ejecuciones y consultas de contratos inteligentes usando el mismo código y herramientas similares para lograr la equivalencia de EVM. Todas las transacciones de contratos inteligentes se ejecutan usando [Besu EVM](../../support-and-community/glossary. d#hyperledger-besu-evm) para realizar este objetivo, y los cambios resultantes se almacenan en el estado [Virtual Merkle Tree](../../support-and-community/glossary.md#virtual-merkle-tree). Por lo tanto, los usuarios tienen garantizada una finalidad determinista (a diferencia de la final probabilista) de las ejecuciones de contratos inteligentes en un plazo de 2-3 segundos, al tiempo que aseguran que los cambios de estado se compaginen por completo dentro de la funcionalidad del contrato inteligente. 20 x

{% hint style="info" %}
🔔 Un desglose completo de los objetivos y excepciones de la equivalencia EVM de Hedera se puede encontrar [**aquí**](hederas-evm-equivalence-goals-and-exceptions.md).&#x20;
{% endhint %}

***

## Modelo de seguridad

### Límites del modelo antiguo (v1)

El antiguo modelo de seguridad (pre [0.35.2](https://github.com/hashgraph/hedera-services/releases/tag/v0.35.2)) soporta firmas clave de cuenta proporcionadas en tiempo de transacción para su autorización. Algunas de las características clave de este modelo incluyeron:

- [Contratos inteligentes](../../support-and-community/glossary.md#smart-contract) sólo podían cambiar su propio almacenamiento o el almacenamiento con el que fueron [delegados llamados](https://docs.soliditylang.org/en/v0.8.19/introduction-to-smart-contracts.html#delegatecall-and-libraries) con.
- Los contratos inteligentes del sistema podrían delegarse para llevar a cabo [Hedera Token Service (HTS)](../../support-and-community/glossary. d#hedera-token-service-hts) operaciones en nombre de otra cuenta - Cuenta de Propiedad Externa (EOA) o cuenta de contrato.
- Smart Contracts podría cambiar el almacenamiento de una EOA con la firma apropiada en la transacción.
- Smart Contracts podría cambiar el saldo de una EOA con la firma apropiada en la transacción o con la adición previa a una lista de autorización de permisos.

Esta experiencia de usuario mejoró considerablemente ya que los contratos podrían combinar transacciones en un intento de atomicidad. Por ejemplo, un contrato podría asociar, transferir y aprobar transacciones en nombre de un usuario con una firma. Al centrarse en la usabilidad, este enfoque no abordó casos en los que los malos actores pudieran llevar a cabo una transacción no autorizada en nombre de un usuario, e. ., [https://hedera. om/blog/analysis-remediation-/etcprecompile-attack-on-the-hedera-network](https://hedera.com/blog/analysis-remediation-.Uprecompile-attack-on-the-hedera-network)

Para abordar esto, los ingenieros de Hedera analizaron a fondo el Servicio de Contratos Inteligentes y los contratos del sistema HTS, con el objetivo de asegurar el estado y los activos de token de los usuarios y la red durante las ejecuciones de Smart Contract. Los resultados de este esfuerzo son las pautas en [la versión v0.35.2](https://github.com/hashgraph/hedera-services/releases/tag/v0.35.2).

### Límites del nuevo modelo (v2)

En el nuevo modelo de seguridad, las firmas clave de cuenta no pueden proporcionar autorización para las acciones de contrato. Sus características clave incluyen:

- Los contratos inteligentes sólo pueden cambiar su propio almacenamiento o el almacenamiento al que fueron llamadas [delegados](https://docs.soliditylang.org/en/v0.8.19/introduction-to-smart-contracts.html#delegatecall-and-libraries) con.
- Los contratos inteligentes del sistema **no** pueden ser llamados delegados, excepto del flujo proxy/facade de Token, por ejemplo, [HIP 719](https://hips.hedera.com/hip/hip-719). En tales casos, los tokens HTS se representan como contratos inteligentes (ver [HIP 218](https://hips.hedera.com/hip/hip-218)) para buscar métodos ERC comunes.
- Smart contracts can change a EOAs storage only if the contract ID is contained in the EOAs key.
- Los contratos inteligentes pueden cambiar un balance de EOAs si son aprobados para una asignación de tokens para un token específico en poder de la EOA.

#### Tabla de comparación límite

<table data-full-width="false"><thead><tr><th width="191">Origen límite</th><th width="238">v1 Modelo</th><th width="225">v2 Modelo</th><th align="center">Cambiar</th></tr></thead><tbody><tr><td>Cambios de almacenamiento</td><td>Smart Contracts sólo pudo cambiar su propio almacenamiento o el almacenamiento con el que fueron delegados</td><td>Los contratos inteligentes sólo pueden cambiar su propio almacenamiento o el almacenamiento con el que fueron delegados</td><td align="center"><strong>N</strong></td></tr><tr><td>Tipos de llamadas del Contrato del Sistema</td><td>Los contratos inteligentes del sistema podrían ser llamados con el fin de llevar a cabo operaciones del Servicio Hedera Token en nombre de otra cuenta (EOA) o contrato.</td><td>Los contratos inteligentes del sistema no pueden ser llamados a la delegación, excepto en el flujo de fachada de Token, que presenta los tokens HTS como contratos inteligentes para métodos ERC comunes.</td><td align="center"><strong>Y</strong></td></tr><tr><td>Cambios de almacenamiento de cuenta autorizados</td><td>Smart Contracts podría cambiar el almacenamiento de una EOA con la firma apropiada en la transacción.</td><td>Smart contracts can change a EOAs storage if the contract ID is contained in the EOAs keyy.</td><td align="center"><strong>Y</strong></td></tr><tr><td>Cambios de saldo de cuenta permitidos</td><td>Smart Contracts podría cambiar un balance de cuentas (EOA o contrato) con la firma apropiada en la transacción o con la adición previa a una lista de permisos</td><td>Los contratos inteligentes pueden cambiar el equilibrio de los EOA si han sido aprobados un permiso de token.</td><td align="center"><strong>Y</strong></td></tr></tbody></table>

En resumen, HSCS utiliza un enfoque de seguridad de tres niveles:

1. **Nivel 0 - Modelo de Seguridad EVM:** Las entidades sólo pueden modificar su propio estado y balance.
2. **Nivel 1 - Modelos de seguridad del valor de la cuenta ERC:** La transferencia y el acceso al valor de la cuenta seguirán estándares de interfaz web 3, por ejemplo, ERC20, ERC721.
3. **Nivel 2 - Características de seguridad avanzada de Hedera:** Las características únicas de Hedera pueden utilizar permisos compatibles con contratos, por ejemplo, claves ContractID.

<figure><img src="../../.gitbook/assets/SecurityModel01a.png" alt="" width="188"><figcaption><p>El modelo de seguridad de contrato inteligente de tres niveles de Hedera</p></figcaption></figure>

Para lograr el cambio de estado o la transferencia de valor, las ejecuciones deben cumplir las reglas de cada nivel. Las transacciones que no satisfagan la autorización apropiada fallarán con códigos de respuesta como `INVALID_FULL_PREFIX_SIGNATURE_FOR_PRECOMPILE` cuando un remitente no está autorizado a realizar una operación. Se devolverán códigos de respuesta más específicos para cada operación donde corresponda, por ejemplo, `SPENDER_DOES_NOT_HAVE_ALLOWANCE`.

***

## Impacto en desarrolladores

### Como desarrollador en Hedera, ¿qué debo hacer?

Se recomienda encarecidamente a los desarrolladores que prueben sus aplicaciones con nuevos contratos y UX usando el nuevo modelo de seguridad para evitar consecuencias no intencionadas.

- El nuevo modelo de seguridad ha sido aplicado a contratos creados desde la [versión 0.35.2](../../networks/release-notes/services.md#0.35.2-hedera-smart-contract-service-security-model-changes) y en adelante.
- Los contratos existentes desplegados antes de esta actualización seguirán utilizando el modelo de seguridad anterior por un tiempo limitado para permitir modificaciones de aplicación/UX.
- El modelo de seguridad anterior sólo se mantendrá durante aproximadamente tres meses. El objetivo actual es que la red elimine el modelo de seguridad anterior y que todos los contratos sigan el nuevo modelo en la versión mainnet de julio de 2023.
- Ver una lista completa de las actualizaciones de seguridad realizadas [here](security.md#0.35.2).&#x20

### ¿Qué significa el cambio en el modelo de seguridad para los promotores de contratos inteligentes?

La actualización de seguridad implica cambios a los permisos de entidad durante las ejecuciones de contrato al modificar el estado. En resumen, las llamadas al contrato del sistema (llamadas de contrato inteligentes al servicio de Token de Hedera) ya no se ejecutan con todos los privilegios de llamadas superiores, incluso si el usuario autorizado proporciona una firma.

Entender el proceso de ejecución de contratos tanto para cuentas de propiedad externa (EOA) como para contratos durante llamadas regulares y delegados es crucial. Este proceso implica el seguimiento de cómo las cuentas, el estado (almacenamiento y saldo de valores) y el código pueden cambiar a medida que avanza a través de la cadena de llamadas.

#### Antes (modelo v1)

En un escenario de llamada regular, cuando se hace una llamada al contrato B, el código B se ejecuta en el contexto de su propio estado. Esto permite que B modifique sólo su propio estado. El valor del remitente también difiere entre las llamadas para destacar que la EOA hizo la primera llamada y el contrato A el segundo.

<figure><img src="../../.gitbook/assets/SecurityModel02rev - EOA.png" alt=""><figcaption></figcaption></figure>

#### Después (modelo v2)

Por otra parte, en una llamada delegada scenario, la llamada al contrato B ve el código B ejecutado en el contexto del estado de A. Esto permite a B modificar el estado de A. Los valores del remitente y del destinatario se conservan de la primera llamada como si la EOA iniciara la llamada.

<figure><img src="../../.gitbook/assets/SecurityModel03b - EOA.png" alt=""><figcaption></figcaption></figure>

En resumen, una llamada delegada ejecuta el código del contrato de llamada en el contexto de la cuenta anterior, dando acceso al código al estado de la cuenta anterior y difuminando las líneas de gestión autorizada.

Aplicando esto al modelo de seguridad cambia, la siguiente tabla resume los cambios en la comprobación de autorización.

<table><thead><tr><th width="296">Escenario</th><th width="227">Verificación de autorización</th><th width="107" align="center">Modelo antiguo</th><th align="center">Nuevo modelo</th></tr></thead><tbody><tr><td>Smart contrato A puede cambiar su propio estado usando una llamada</td><td>remitente = Contrato A</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td>Smart contrato A puede cambiar el estado de EOA mediante llamada</td><td>sender = EOA</td><td align="center">N</td><td align="center">N</td></tr><tr><td>Smart contract B puede cambiar el estado del contrato A a través de una llamada</td><td>remitente = A</td><td align="center">N</td><td align="center">N</td></tr><tr><td>Smart contract A puede cambiar el estado de EOA mediante una llamada delegada</td><td>sender = EOA</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td>Smart contract B puede cambiar el estado del contrato A a través de una llamada delegada</td><td>remitente = Contrato A</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td>Los contratos inteligentes del sistema pueden cambiar otras cuentas (EOA o estado del contrato A o del contrato B) mediante una llamada</td><td>remitente = cuenta</td><td align="center">N</td><td align="center">N</td></tr><tr><td>El contrato inteligente del sistema puede cambiar otras cuentas EOA o el estado del contrato A o el contrato B) a través de una llamada delegada</td><td>remitente = cuenta</td><td align="center">N</td><td align="center">N</td></tr><tr><td><strong>Los contratos del sistema pueden cambiar una cuenta (EOA o ponerse en contacto con el estado A o el contrato B) mediante una llamada con la firma apropiada</strong></td><td><strong>signature map contains signature of accounts (EOA or contact A or contract B respectively)</strong></td><td align="center"><strong>Y</strong></td><td align="center"><strong>N</strong></td></tr><tr><td><strong>El contrato inteligente del sistema puede cambiar otras cuentas (EOA o ponerse en contacto con el estado A o el contrato B) mediante una llamada delegada con la firma apropiada</strong></td><td><strong>signature map contains signature of accounts (EOA or contact A or contract B)</strong></td><td align="center"><strong>Y</strong></td><td align="center"><strong>N</strong></td></tr><tr><td>El contrato A o B puede llamar a un contrato del sistema a través de una llamada</td><td>-</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td><strong>El contrato A o B puede llamar a un contrato del sistema a través de una llamada delegada</strong></td><td><strong>-</strong></td><td align="center"><strong>Y</strong></td><td align="center"><strong>N</strong></td></tr></tbody></table>

En el momento del cambio, el [contrato del sistema HTS](https://github.com/hashgraph/hedera-smart-contracts/tree/release/0.3/contracts/hts-precompile) era la única vía para exponer la funcionalidad de la API de Hedera a través de Smart Contracts. Como tal, es justo considerar las diferencias entre las actualizaciones de modelos anteriores y posteriores a la seguridad al observar las funciones de cambio de estado de los contratos HTS del sistema.

#### Resumen de impactos del contrato del sistema HTS existente

<table data-full-width="false"><thead><tr><th width="212" align="center">Función de contrato inteligente del sistema IHederaTokenService</th><th width="147" align="center">Requisitos de autorización de modelos v1</th><th width="139" align="center">Requisitos de autorización de modelos v2</th><th width="96" align="center">Código de impactos</th><th align="center">Solución de desarrolladores</th></tr></thead><tbody><tr><td align="center"><strong>aprobar, aprobar NFT</strong></td><td align="center">el mapa de la firma contiene la clave de administración de cuentas</td><td align="center"><code>msg.sender</code> debe ser una entidad para ser modificada</td><td align="center">Y</td><td align="center"><p>Mejorar contratos</p><p></p><p>o</p><p></p><p>Actualizar DApps para proporcionar la aprobación explícita del usuario</p><p></p><p><mark style="background-color:yellow;">*Vías seguras adicionales:</mark> <a href="https://hips.hedera.com/hip/hip-376"><mark style="background-color:yellow;">HIP 376</mark></a> <mark style="background-color:yellow;">IERC.approve()</mark></p></td></tr><tr><td align="center"><strong>asociateToken</strong></td><td align="center">el mapa de la firma contiene la clave de administrador de la cuenta</td><td align="center"><code>msg.sender</code> debe ser una entidad para ser modificada</td><td align="center">Y</td><td align="center"><p>Mejorar contratos</p><p></p><p>o </p><p></p><p>Actualizar DApps para proporcionar un usuario asociado explícito</p><p></p><p><mark style="background-color:yellow;">*Additional secure pathways:</mark> <a href="https://hips.hedera.com/hip/hip-719"><mark style="background-color:yellow;">HIP 719</mark></a> <mark style="background-color:yellow;">IHRC.associate()</mark></p></td></tr><tr><td align="center"><strong>burnToken</strong></td><td align="center"><p>el mapa de la firma contiene la clave de grabación de token</p><p></p><p>o</p><p></p><p>Contract Id satisface los requisitos de Token.supplyKey</p></td><td align="center">Contract Id satisface los requisitos de Token.supplyKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la clave de suministro</td></tr><tr><td align="center"><strong>createFungibleToken, createFungibleTokenWithCustomFees, createNonFungibleToken, createNonFungibleTokenWithCustomFees</strong></td><td align="center"><p>el mapa de la firma contiene la clave de administrador de la cuenta afectada en el tesoro </p><p></p><p>o </p><p></p><p>auto Renovar caso de asignación</p></td><td align="center"><p><code>msg.sender</code> debe ser una entidad para ser modificada en tesorería </p><p></p><p>o </p><p></p><p>auto Renovar caso de asignación</p></td><td align="center">Y</td><td align="center">-</td></tr><tr><td align="center"><strong>cryptoTransfer</strong></td><td align="center"><p>el mapa de la firma contiene la clave de administrador del remitente </p><p></p><p>o </p><p></p><p>Contract Id satisface los requisitos de Entity.key</p></td><td align="center"><p><code>msg.sender</code> debe ser una entidad para ser modificada en tesorería </p><p></p><p>o </p><p></p><p>auto Renovar caso de asignación</p></td><td align="center">Y</td><td align="center">Actualiza DApps para proporcionar aprobación explícita del usuario.</td></tr><tr><td align="center"><strong>deleteToken</strong></td><td align="center"><p>el mapa de la firma contiene la clave de admin de token </p><p></p><p>o </p><p></p><p>Contract Id satisface los requisitos de Token.adminKey</p></td><td align="center">Contract Id satisface los requisitos de Token.adminKey</td><td align="center">Y</td><td align="center">El administrador debe establecer el contrato deseado en la clave de administración</td></tr><tr><td align="center"><strong>dissociateToken, dissociateTokens</strong></td><td align="center">el mapa de la firma contiene la clave de administración</td><td align="center"><code>msg.sender</code> debe ser una entidad para ser modificada</td><td align="center">Y</td><td align="center"><p>Mejorar contratos</p><p></p><p>o </p><p></p><p>Actualizar DApps para proporcionar una disociación explícita del usuario</p><p></p><p><mark style="background-color:yellow;">*Additional secure pathways:</mark> <a href="https://hips.hedera.com/hip/hip-719"><mark style="background-color:yellow;">HIP 719</mark></a> <mark style="background-color:yellow;">IHRC.associate()</mark></p></td></tr><tr><td align="center"><strong>congelación</strong></td><td align="center"><p>el mapa de firma contiene la firma de la clave de congelación </p><p></p><p>o </p><p></p><p>Contrato Id satisface los requerimientos Token.freezeKey</p></td><td align="center">Contrato Id satisface los requerimientos Token.freezeKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la clave de bloqueo</td></tr><tr><td align="center"><strong>grantTokenKyc</strong></td><td align="center"><p>el mapa de la firma contiene la clave kyc </p><p></p><p>o </p><p></p><p>Contrato Id satisface los requerimientos Token.freezeKey</p></td><td align="center">Contrato Id cumple con los requerimientos Token.kycKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la clave kyc</td></tr><tr><td align="center"><strong>mintToken</strong></td><td align="center"><p>el mapa de la firma contiene la firma apropiada </p><p></p><p>o </p><p></p><p>Contract Id satisface los requisitos de Token.supplyKey</p></td><td align="center">Contract Id satisface los requisitos de Token.supplyKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la clave de suministro</td></tr><tr><td align="center"><strong>pauseToken</strong></td><td align="center"><p>el mapa de la firma contiene la pausa de la firma </p><p></p><p>o </p><p></p><p>Contrato Id satisface los requisitos de Token.pauseKey</p></td><td align="center">Contrato Id satisface los requisitos de Token.pauseKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la tecla de pausa</td></tr><tr><td align="center"><strong>revokeTokenKyc</strong></td><td align="center"><p>el mapa de la firma contiene la clave kyc </p><p></p><p>o </p><p></p><p>Contrato Id satisface los requerimientos Token.freezeKey</p></td><td align="center">Contrato Id cumple con los requerimientos Token.kycKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la clave kyc</td></tr><tr><td align="center"><strong>setApprovalForAll</strong></td><td align="center">el mapa de la firma contiene la clave de administración</td><td align="center"><code>msg.sender</code> debe ser una entidad para ser modificada</td><td align="center">Y</td><td align="center"><p>Mejorar contratos</p><p></p><p>o</p><p></p><p>Actualizar DApps para proporcionar un usuario asociado explícito</p><p></p><p><mark style="background-color:yellow;">*Additional secure pathways:</mark> <a href="https://hips.hedera.com/hip/hip-376"><mark style="background-color:yellow;">HIP 376</mark></a> <mark style="background-color:yellow;">IERC.setApprovalForAll()</mark></p></td></tr><tr><td align="center"><strong>transferFrom, transferFromNFT</strong></td><td align="center"><p>el mapa de la firma contiene la clave de administración </p><p></p><p>o </p><p></p><p>El gasto debe haber sido pre-aprobado un subsidio</p></td><td align="center"><p><code>msg.sender</code> debe ser una entidad para ser modificada en tesorería </p><p></p><p>o </p><p></p><p>auto Renovar caso de asignación</p></td><td align="center">Y</td><td align="center">Actualiza DApps para proporcionar aprobación explícita del usuario.</td></tr><tr><td align="center"><strong>transferToken, transferTokens, transferNFT, transferNFT</strong></td><td align="center"><p>el mapa de la firma contiene la clave de administración </p><p></p><p>o </p><p></p><p>Contract Id satisface los requisitos de Entity.key </p><p></p><p>o </p><p></p><p>El contrato ha sido aprobado una asignación para gastar por el propietario</p></td><td align="center"><p><code>msg.sender</code> debe ser dueño del balance. </p><p></p><p>Si no 1. Contract Id satisface los requisitos de Entity.key </p><p></p><p>o </p><p></p><p>2. El contrato ha sido aprobado una asignación para gastar por el propietario</p></td><td align="center">Y</td><td align="center">Actualiza DApps para proporcionar aprobación explícita del usuario.</td></tr><tr><td align="center"><strong>updateTokenInfo, updateTokenExpiryInfo, updateTokenKeys</strong></td><td align="center"><p>el mapa de la firma contiene la clave de admin de token </p><p></p><p>o </p><p></p><p>Contract Id satisface los requisitos de Token.adminKey</p></td><td align="center">Contract Id satisface los requisitos de Token.adminKey</td><td align="center">Y</td><td align="center">El administrador debe establecer el contrato deseado en la clave de administración</td></tr><tr><td align="center"><strong>wipeTokenAccount, wipeTokenAccountNFT</strong></td><td align="center"><p>el mapa de firma contiene la firma de la clave de borrado de token </p><p></p><p>o </p><p></p><p>Contrato Id cumple con los requisitos de Token.wipeKey</p></td><td align="center">Contrato Id cumple con los requisitos de Token.wipeKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la clave de borrado</td></tr><tr><td align="center"><strong>unfreezeToken</strong></td><td align="center"><p>el mapa de la firma contiene la firma de la clave de bloqueo de fichas </p><p></p><p>o </p><p></p><p>Contrato Id satisface los requerimientos Token.freezeKey</p></td><td align="center">Contrato Id satisface los requerimientos Token.freezeKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la clave de bloqueo</td></tr><tr><td align="center"><strong>unpauseToken</strong></td><td align="center"><p>el mapa de la firma contiene token pause key signature </p><p></p><p>o </p><p></p><p>Contrato Id satisface los requisitos de Token.pauseKey</p></td><td align="center">Contrato Id satisface los requisitos de Token.pauseKey</td><td align="center">Y</td><td align="center">El administrador del token debe establecer el contrato deseado en la tecla de pausa</td></tr></tbody></table>

{% hint style="info" %}
**Nota:** Mientras los cambios impactan a la experiencia del usuario, requiriendo pasos más explícitos, incrementan más que proporcionalmente la seguridad del usuario y de la red en todo el foro. El equipo continúa empujando diligentemente para proporcionar a la comunidad soluciones API seguras y escalables para permitirles construir dApps creativos y crear su propio mundo compartido en el contador.
{% endhint %}

***

## Mejoras de seguridad

<details>

<summary>0.35.2</summary>

- Después del incidente de seguridad del 9 de marzo, los ingenieros llevaron a cabo un análisis exhaustivo del Servicio de Contratos Inteligentes y los contratos del sistema de Token de Hedera.
- Como parte de este ejercicio, no encontramos ninguna vulnerabilidad adicional que pudiera resultar en un ataque que presenciamos el 9 de marzo.
- El equipo también buscó diferencias entre las expectativas de un desarrollador típico de contratos inteligentes que está acostumbrado a trabajar con las APIs de Ethereum Virtual Machine (EVM) o ERC token y los comportamientos de las APIs del sistema de servicios Hedera Token . Tales diferencias de comportamiento podrían ser utilizadas por un desarrollador malicioso de contratos inteligentes de maneras inesperadas.
- Con el fin de eliminar la posibilidad de que estas diferencias de comportamiento sean utilizadas como vectores de ataque en el futuro, el software de nodo consensuado alineará los comportamientos del sistema de tokens Hedera Smart Contract Service con los de EVM y las API de token típicas como ERC 20 y ERC 721.
- Como resultado, los siguientes cambios se hacen a partir de la versión 0.35.2 del mainnet el 31 de marzo:
  - Una EOA (cuenta de propiedad externa) tendrá que proporcionar una aprobación/asignación explícita a un contrato si quieren que el contrato transfiera valor desde el saldo de su cuenta.
  - El comportamiento del contrato del sistema `transferFrom` será exactamente el mismo que el de la función ERC 20 y ERC 721 spec `transferFrom`.
  - Para la funcionalidad HTS específica del token (e.g. Pausar, congelar o conceder KYC), un contrato estará autorizado para realizar la función de administración de token asociada sólo si el ContractId se enumera como una clave en el token (i.e. Pausar clave, congelar clave, KYC Key respectivamente).
  - Las APIs `transferToken` y `transferNFT` se comportarán como `transfer` en ERC20/721 si la persona que llama posee el valor que está siendo transferida, de lo contrario dependerá de la aprobación de las dietas de gasto del propietario del token.
  - El modelo anterior dictará los permisos de entidad (EOA y contratos) durante las ejecuciones del contrato al modificar el estado. Los contratos ya no dependerán de la presencia de la firma de la transacción de Hedera, sino que estarán de acuerdo con los modelos clave EVM, ERC y ContractId señalados.
- Como parte de este lanzamiento, la red incluirá lógica para el abuelo en contratos anteriores.
  - Cualquier contrato creado a partir de esta versión en adelante utilizará el modelo de seguridad más estricto y como tal no tendrá en cuenta las firmas de alto nivel en las transacciones para proporcionar permisos.
  - Los contratos existentes desplegados antes de esta actualización serán automáticamente abarrotados y continuarán utilizando el modelo antiguo que estaba en vigor antes de esta versión por un tiempo limitado para permitir que la modificación DApp/UX funcione con el nuevo modelo de seguridad.
  - La lógica del abuelo se mantendrá por un período aproximado de 3 meses a partir de esta versión. En un futuro lanzamiento en julio de 2023, la red eliminará la lógica del abuelo, y todos los contratos seguirán el nuevo modelo de seguridad.
  - Se anima a los desarrolladores a probar sus DApps con nuevos contratos y UX usando el nuevo modelo de seguridad para evitar consecuencias no intencionadas. Si algún desarrollador de DApp no modifica sus aplicaciones o actualiza sus contratos (según corresponde) para adherirse al nuevo modelo de seguridad, pueden experimentar problemas en sus aplicaciones.

</details>
